generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id                      String              @id @default(uuid())
  username                String              @unique
  email                   String?             @unique
  passwordHash            String
  firstName               String?
  lastName                String?
  badgeNumber             String?
  role                    String              @default("VIEWER")
  active                  Boolean             @default(true)
  permViewReports         Boolean             @default(true)
  permAssignReports       Boolean             @default(false)
  permViewSensitiveData   Boolean             @default(false)
  permBulkActionReports   Boolean             @default(false)
  permManageUsers         Boolean             @default(false)
  permCreateOfficers      Boolean             @default(false)
  permEditOfficers        Boolean             @default(false)
  permDeleteOfficers      Boolean             @default(false)
  permViewOfficerStats    Boolean             @default(false)
  permCreateEvaluations   Boolean             @default(false)
  permManageOfficerStatus Boolean             @default(false)
  permEditCitizens        Boolean             @default(false)
  permDeleteCitizens      Boolean             @default(false)
  permMarkSuspicious      Boolean             @default(false)
  permEditNotes           Boolean             @default(true)
  permChangeStatus        Boolean             @default(true)
  permExportData          Boolean             @default(false)
  permDeleteReports       Boolean             @default(false)
  permViewAudit           Boolean             @default(false)
  permManageSettings      Boolean             @default(false)
  permManageMailAlerts    Boolean             @default(false)
  createdAt               DateTime            @default(now())
  phone                   String?
  notifications           AdminNotification[]
  auditLogs               AuditLog[]
  notificationReads       NotificationRead[]
  evaluations             OfficerEvaluation[] @relation("Evaluations")
  assignedResponses       Response[]          @relation("AssignedTo")
  assignedUnifiedRecords  UnifiedRecord[]     @relation("AssignedUnifiedRecords")
}

model Settings {
  id                      String   @id @default("global")
  unitName                String   @default("Патрульна поліція Хмільницького району")
  unitAddress             String   @default("")
  emergencyPhone          String   @default("102")
  criticalRatingThreshold Float    @default(2.5)
  piiRetentionDays        Int      @default(30)
  welcomeMessage          String   @default("Вітаємо в системі відгуків про роботу патрульної поліції.")
  warningKeywords         String   @default("корупція, хабар, насилля, катування")
  updatedAt               DateTime @updatedAt
}

model Survey {
  id          String     @id @default(uuid())
  title       String
  description String?
  status      String     @default("ACTIVE")
  opensAt     DateTime?
  closesAt    DateTime?
  createdById String?
  createdAt   DateTime   @default(now())
  responses   Response[]
}

model Response {
  id                  String       @id @default(uuid())
  surveyId            String?
  createdAt           DateTime     @default(now())
  submittedAt         DateTime?
  clientGeneratedId   String       @unique
  ipHash              String?
  userAgent           String?
  suspicious          Boolean      @default(false)
  consent             Boolean
  wantContact         Boolean
  districtOrCity      String?
  interactionDate     DateTime?
  interactionTime     String?
  incidentType        String?
  responseTimeBucket  String?
  patrolRef           String?
  officerName         String?
  badgeNumber         String?
  ratePoliteness      Int?
  rateProfessionalism Int?
  rateEffectiveness   Int?
  rateOverall         Int?
  comment             String?
  status              String       @default("NEW")
  internalNotes       String?
  assignedToId        String?
  resolutionNotes     String?
  resolutionDate      DateTime?
  incidentCategory    String?
  isConfirmed         Boolean      @default(true)
  officerId           String?
  citizenId           String?
  attachments         Attachment[]
  contact             Contact?
  geoPoint            GeoPoint?
  citizen             Citizen?     @relation("CitizenResponses", fields: [citizenId], references: [id])
  officer             Officer?     @relation("OfficerFeedback", fields: [officerId], references: [id])
  assignedTo          User?        @relation("AssignedTo", fields: [assignedToId], references: [id])
  survey              Survey?      @relation(fields: [surveyId], references: [id])
  taggedOfficers      Officer[]    @relation("TaggedOfficers")
}

model Contact {
  id         String   @id @default(uuid())
  responseId String   @unique
  name       String?
  phone      String
  response   Response @relation(fields: [responseId], references: [id])
}

model GeoPoint {
  id             String   @id @default(uuid())
  responseId     String   @unique
  lat            Float
  lon            Float
  accuracyMeters Float?
  source         String
  precisionMode  String   @default("approx")
  createdAt      DateTime @default(now())
  response       Response @relation(fields: [responseId], references: [id])
}

model Attachment {
  id           String             @id @default(uuid())
  responseId   String?
  storage      String             @default("local")
  mediaType    String             @default("photo")
  pathOrKey    String
  mime         String
  sizeBytes    Int
  hash         String
  exifStripped Boolean            @default(true)
  evaluationId String?
  createdAt    DateTime           @default(now())
  evaluation   OfficerEvaluation? @relation(fields: [evaluationId], references: [id])
  response     Response?          @relation(fields: [responseId], references: [id])
}

model AuditLog {
  id          String   @id @default(uuid())
  actorUserId String?
  action      String
  entityType  String?
  entityId    String?
  metadata    String?
  createdAt   DateTime @default(now())
  actorUser   User?    @relation(fields: [actorUserId], references: [id])
}

model Officer {
  id                String              @id @default(uuid())
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  badgeNumber       String              @unique
  firstName         String
  middleName        String?
  lastName          String
  rank              String?
  department        String?
  imageUrl          String?
  phone             String?
  hireDate          DateTime?
  birthDate         DateTime?
  address           String?
  education         String?
  email             String?
  driversLicense    String?
  status            String              @default("ACTIVE")
  avgScore          Float               @default(0)
  totalEvaluations  Int                 @default(0)
  totalResponses    Int                 @default(0)
  evaluations       OfficerEvaluation[]
  responses         Response[]          @relation("OfficerFeedback")
  taggedInResponses Response[]          @relation("TaggedOfficers")

  @@index([lastName, firstName])
  @@index([badgeNumber])
  @@index([avgScore])
}

model OfficerEvaluation {
  id                   String       @id @default(uuid())
  createdAt            DateTime     @default(now())
  officerId            String
  evaluatorId          String?
  type                 String
  sourceId             String?
  scoreKnowledge       Int?
  scoreTactics         Int?
  scoreCommunication   Int?
  scoreProfessionalism Int?
  scorePhysical        Int?
  strengths            String?
  weaknesses           String?
  recommendations      String?
  notes                String?
  issuesJson           String?
  isConfirmed          Boolean      @default(true)
  attachments          Attachment[]
  evaluator            User?        @relation("Evaluations", fields: [evaluatorId], references: [id])
  officer              Officer      @relation(fields: [officerId], references: [id], onDelete: Cascade)
}

model AdminNotification {
  id        String             @id @default(uuid())
  type      String
  priority  String             @default("NORMAL")
  title     String
  message   String
  link      String?
  read      Boolean            @default(false)
  createdAt DateTime           @default(now())
  userId    String?
  user      User?              @relation(fields: [userId], references: [id])
  readBy    NotificationRead[]
}

model NotificationRead {
  id             String            @id @default(uuid())
  notificationId String
  userId         String
  readAt         DateTime          @default(now())
  user           User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  notification   AdminNotification @relation(fields: [notificationId], references: [id], onDelete: Cascade)

  @@unique([notificationId, userId])
}

model Citizen {
  id            String         @id @default(uuid())
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  phone         String?        @unique
  ipHash        String?
  fullName      String?
  internalNotes String?
  isVip         Boolean        @default(false)
  isSuspicious  Boolean        @default(false)
  phones        CitizenPhone[]
  responses     Response[]     @relation("CitizenResponses")

  @@index([ipHash])
}

model CitizenPhone {
  id        String   @id @default(uuid())
  citizenId String
  phone     String   @unique
  createdAt DateTime @default(now())
  citizen   Citizen  @relation(fields: [citizenId], references: [id], onDelete: Cascade)
}

model UnifiedRecord {
  id             String    @id @default(uuid())
  eoNumber       String    @unique
  eoDate         DateTime
  district       String?
  address        String?
  description    String?
  applicant      String?
  category       String?
  officerName    String?
  assignedUserId String?
  resolution     String?
  resolutionDate DateTime?
  sourceFile     String?
  importedAt     DateTime  @default(now())
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  assignedUser   User?     @relation("AssignedUnifiedRecords", fields: [assignedUserId], references: [id])

  @@index([eoNumber])
  @@index([eoDate])
  @@index([category])
}
